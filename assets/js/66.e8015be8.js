(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{385:function(t,a,s){"use strict";s.r(a);var n=s(33),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"steps"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#steps"}},[t._v("#")]),t._v(" steps")]),t._v(" "),s("h2",{attrs:{id:"基本指令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本指令"}},[t._v("#")]),t._v(" 基本指令")]),t._v(" "),s("p",[s("code",[t._v("steps")]),t._v(" 指令用来设置具体的构建步骤，每个步骤均运行在容器中，所以每个步骤必须首先指定 Docker Image 名称 ("),s("code",[t._v("image")]),t._v(") 和具体的运行指令 ("),s("code",[t._v("run")]),t._v(") 。")]),t._v(" "),s("blockquote",[s("p",[t._v("steps 指令可以包含多个构建步骤")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("php")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" khs1994/php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fpm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.4.5"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alpine\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" composer install "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("q\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" vendor/bin/phpunit\n\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("public")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("      \n")])])]),s("h2",{attrs:{id:"_1-image"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-image"}},[t._v("#")]),t._v(" 1. "),s("code",[t._v("image")])]),t._v(" "),s("p",[t._v("设置构建步骤所使用的镜像。")]),t._v(" "),s("h2",{attrs:{id:"_2-run"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-run"}},[t._v("#")]),t._v(" 2. "),s("code",[t._v("run")])]),t._v(" "),s("p",[t._v("设置构建步骤所运行的命令。")]),t._v(" "),s("h2",{attrs:{id:"_3-env"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-env"}},[t._v("#")]),t._v(" 3. "),s("code",[t._v("env")])]),t._v(" "),s("p",[t._v("除了以上两个基本指令外，还可以像我们平时使用 "),s("code",[t._v('$ docker container run -e "K=V" ...')]),t._v(" 命令那样设置 "),s("strong",[t._v("环境变量")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("php")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" khs1994/php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fpm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.4.5"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alpine\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" key=value\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" composer install "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("q\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" vendor/bin/phpunit\n")])])]),s("p",[t._v("如果你设置的 env 依赖系统级 ENV 例如 "),s("code",[t._v("${HOME}")]),t._v(" "),s("code",[t._v("${PATH}")]),t._v("，请勿在 "),s("code",[t._v("env")]),t._v(" 指令中设置，请在 "),s("code",[t._v("run")]),t._v(" 指令中使用 "),s("code",[t._v("export ...")]),t._v(" 命令设置变量。")]),t._v(" "),s("div",{staticClass:"language-diff extra-class"},[s("pre",{pre:!0,attrs:{class:"language-diff"}},[s("code",[s("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("  env:\n    - k=v\n")]),s("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[t._v("-   - key=${HOME}\n-   - PATH=${PATH}:/my/path\n")]),s("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+ run:\n+   - export key=${HOME}\n+   - export PATH=${PATH}:/my/path\n")])])])]),s("h2",{attrs:{id:"_4-pull"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-pull"}},[t._v("#")]),t._v(" 4. "),s("code",[t._v("pull")])]),t._v(" "),s("p",[t._v("每次构建时，无论 Docker Image 是否存在总是拉取镜像，可以使用 "),s("code",[t._v("pull: true")]),t._v(" 指令(默认为 "),s("code",[t._v("false")]),t._v(")。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("php")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" khs1994/php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fpm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.4.5"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alpine\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pull")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" composer install "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("q\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" vendor/bin/phpunit\n")])])]),s("h2",{attrs:{id:"_5-shell"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-shell"}},[t._v("#")]),t._v(" 5. "),s("code",[t._v("shell")])]),t._v(" "),s("p",[t._v("默认的 shell 为 "),s("code",[t._v("sh")]),t._v("，你可以改为 "),s("code",[t._v("bash")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("php")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" khs1994/php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fpm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.4.5"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alpine\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" bash\n")])])]),s("p",[t._v("全部支持的 "),s("code",[t._v("shell")]),t._v(" 包括 "),s("code",[t._v("sh")]),t._v(" "),s("code",[t._v("bash")]),t._v(" "),s("code",[t._v("python")]),t._v(" "),s("code",[t._v("pwsh")]),t._v(" "),s("code",[t._v("node")]),t._v(" "),s("code",[t._v("deno")])]),t._v(" "),s("h2",{attrs:{id:"_6-if"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-if"}},[t._v("#")]),t._v(" 6. "),s("code",[t._v("if")])]),t._v(" "),s("p",[t._v("可以通过 "),s("code",[t._v("if")]),t._v(" 指令设置构建条件。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("php")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" khs1994/php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fpm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.4.5"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("alpine\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" composer install "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("q\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" vendor/bin/phpunit\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("event")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" tag\n")])])]),s("p",[t._v("增加以上的 "),s("code",[t._v("if")]),t._v(" 指令之后，构建仅在 Git 打标签之后执行，当 push、pull_request 均不进行构建。")]),t._v(" "),s("p",[t._v("全部可用的设置如下：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# platform: linux/amd64")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# platform:  [ linux/*, windows/amd64 ]")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# status: changed")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# status:  [ failure, success ]")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# event: tag")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# event: [push, pull_request, tag, deployment]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("event")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("push"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pull_request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# branch: master")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# branch: prefix/*")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# branch: [master, develop]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# branch:")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   include: [ master, release/* ]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   exclude: [ release/1.0.0, release/1.1.* ]")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# jobs:")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - K: v")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   K2: v2")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   K3: v3")]),t._v("\n")])])]),s("h2",{attrs:{id:"_7-privileged"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-privileged"}},[t._v("#")]),t._v(" 7. "),s("code",[t._v("privileged")])]),t._v(" "),s("p",[t._v("与 "),s("code",[t._v("docker run --privileged")]),t._v(" 参数的行为一致。")]),t._v(" "),s("h2",{attrs:{id:"_8-with"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-with"}},[t._v("#")]),t._v(" 8. "),s("code",[t._v("with")])]),t._v(" "),s("p",[t._v("该指令用来配置插件。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("provider")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("k")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("k2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v2\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("k3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" a\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" b\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" c\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("k4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kk")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" vv\n")])])]),s("p",[t._v("将 "),s("code",[t._v('INPUT_K=v INPUT_K2=v2 INPUT_K3=a,b,c INPUT_K4={"kk":"vv"}')]),t._v(" 作为环境变量传入容器中。")]),t._v(" "),s("h2",{attrs:{id:"_9-read-only"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9-read-only"}},[t._v("#")]),t._v(" 9. "),s("code",[t._v("read_only")])]),t._v(" "),s("p",[t._v("与 "),s("code",[t._v("docker run --read-only")]),t._v(" 参数的行为一致。")])])}),[],!1,null,null,null);a.default=e.exports}}]);